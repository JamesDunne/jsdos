#include "kernel.h"
#include "myjit/jitlib.h"

// pointer to a function accepting one argument of type long and returning long value
typedef int32_t (* plfl)(int32_t);

// Called first from main to init the system.
int sys_init()
{
    // Clear the text screen:
    hw_txt_clear_screen();

    // Return 0 to indicate successful initialization.
    return 0;
}

void sys_done()
{
    // NOTE(jsd): for testing purposes
    assert(0);
}

// Called to halt the system indefinitely.
void sys_sleep()
{
    // TODO(jsd): Want an actual CPU sleep here to save power.
    while (1) { }
}

// Called from main to run the system after `sys_init`.
int sys_run()
{
    // creates a new instance of the compiler
    struct jit * p = jit_init();

    plfl foo;

    // the code generated by the compiler will be assigned to the function `foo'
    jit_prolog(p, &foo);

    // the first argument of the function
    jit_declare_arg(p, JIT_SIGNED_NUM, sizeof(int32_t));

    // moves the first argument into the register R(0)
    jit_getarg(p, R(0), 0);

    // takes the value in R(0), increments it by one, and stores the result into the
    // register R(1)
    jit_addi(p, R(1), R(0), 1);

    // returns from the function and returns the value stored in the register R(1)
    jit_retr(p, R(1));

    // compiles the above defined code
    jit_generate_code(p);

    char intfmt[9] = "\0\0\0\0\0\0\0\0\0";
    size_t pos;
    pos = hw_txt_write_string("foo(  1): ", 0, 0, 0x7);
    hw_txt_write_string(txt_format_hex_int32(intfmt, foo(1)), 0, 0 + pos, 0xf);
    pos = hw_txt_write_string("foo(100): ", 1, 0, 0x7);
    hw_txt_write_string(txt_format_hex_int32(intfmt, foo(100)), 1, 0 + pos, 0xf);
    pos = hw_txt_write_string("foo(255): ", 2, 0, 0x7);
    hw_txt_write_string(txt_format_hex_int32(intfmt, foo(255)), 2, 0 + pos, 0xf);

    // if you are interested, you can dump the machine code
    // this functionality is provided through the `gcc' and `objdump'
    // jit_dump_code(p, 0);

    // cleanup
    jit_free(p);

    uint lastrow = hw_txt_get_rows() - 1;
    hw_txt_clear_row(lastrow);
    hw_txt_write_string("done", lastrow, 0, 0xf);

    return 0;
}
