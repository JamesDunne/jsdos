#include <stdlib.h>
#include <stdio.h>
#include <stdint.h>
#include <unistd.h>
#include "kernel.h"

// includes the header file
#include "myjit/jitlib.h"

// pointer to a function accepting one argument of type long and returning long value
typedef int32_t (* plfl)(int32_t);

int sys_init()
{
    return 0;
}

void sys_sleep()
{
    while (1) { }
}

int sys_run()
{
    // creates a new instance of the compiler
    struct jit * p = jit_init();

    plfl foo;

    // the code generated by the compiler will be assigned to the function `foo'
    jit_prolog(p, &foo);

    // the first argument of the function
    jit_declare_arg(p, JIT_SIGNED_NUM, sizeof(int32_t));

    // moves the first argument into the register R(0)
    jit_getarg(p, R(0), 0);

    // takes the value in R(0), increments it by one, and stores the result into the
    // register R(1)
    jit_addi(p, R(1), R(0), 1);

    // returns from the function and returns the value stored in the register R(1)
    jit_retr(p, R(1));

    // compiles the above defined code
    jit_generate_code(p);

    // checks, if it works
    //printf("Check #1: %li\n", foo(1));
    //printf("Check #2: %li\n", foo(100));
    //printf("Check #3: %li\n", foo(255));

    char intfmt[9] = "\0\0\0\0\0\0\0\0\0";
    hw_txt_write_string("foo(  1): ", 10, 0, 0x7);
    hw_txt_write_string(txt_format_hex_int32(intfmt, foo(1)), 10, 10, 0xf);
    hw_txt_write_string("foo(100): ", 11, 0, 0x7);
    hw_txt_write_string(txt_format_hex_int32(intfmt, foo(100)), 11, 10, 0xf);
    hw_txt_write_string("foo(255): ", 12, 0, 0x7);
    hw_txt_write_string(txt_format_hex_int32(intfmt, foo(255)), 12, 10, 0xf);

    // if you are interested, you can dump the machine code
    // this functionality is provided through the `gcc' and `objdump'
    // jit_dump_code(p, 0);

    // cleanup
    jit_free(p);

    hw_txt_clear_row(24);
    hw_txt_write_string("done", 24, 0, 0xf);

    return 0;
}
